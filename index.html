<script>
const apiUrl =
"https://script.google.com/macros/s/AKfycbw-Ptinh6OwlWtPhU7_BACIZi1AXKJ6ibOsVj_tHA80zHWMFH0b1CygYfhhABt2cbT4vQ/exec";
const SENARAI_BUKU_URL = "senarai_pembelian_buku.pdf";

let selectedTing = null;

/* ======================
   NAVIGATION
====================== */
function go(id){
  document.querySelectorAll(".screen").forEach(s =>
    s.classList.remove("active")
  );
  document.getElementById(id).classList.add("active");
}

function goHome(){
  selectedTing = null;
  const ic = document.getElementById("ic");
  if(ic) ic.value = "";
  go("home");
}

function startSemak(t){
  selectedTing = t;
  document.getElementById("badgeTing").innerText = "Tingkatan " + t;
  go("input");
}

function openSenaraiBuku(){
  window.open(SENARAI_BUKU_URL, "_blank");
}

/* ======================
   UTIL
====================== */
function cleanIC(v){
  return (v || "").replace(/\D/g,"");
}

function showError(msg){
  document.getElementById("errorMsg").innerText = msg;
  go("error");
}

function field(label,value){
  return `
    <div class="field">
      <div class="label">${label}</div>
      <div class="value">${value || "-"}</div>
    </div>
  `;
}

/* ======================
   FIX JANTINA & BANGSA
====================== */
function getJantina(d){
  return d.jantina || d.JANTINA || d.Gender || "-";
}
function getBangsa(d){
  return d.bangsa || d.BANGSA || d.Ras || "-";
}

/* ======================
   SUBMIT
====================== */
async function submitCheck(){
  const ic = cleanIC(document.getElementById("ic").value);

  if(ic.length !== 12){
    showError("No IC mesti 12 digit.");
    return;
  }

  go("loading");

  try{
    const url = apiUrl +
      "?ting=" + selectedTing +
      "&mode=kelas" +
      "&ic=" + ic;

    const res = await fetch(url);
    const data = await res.json();

    if(data.ok === false){
      showError("Rekod tidak dijumpai.");
      return;
    }

    showResult(data);

  }catch(err){
    showError("Ralat sambungan sistem.");
  }
}

/* ======================
   RESULT
====================== */
function showResult(data){
  let html = "";
  html += field("Nama Pelajar", data.nama);
  html += field("Jantina", getJantina(data));
  html += field("Bangsa", getBangsa(data));
  html += field("KDK", data.kdk);
  html += field("KDT", data.kdt);
  html += field("Kelas 2025", data.kelas_2025);
  html += field("Kelas 2026", data.kelas_2026);
  html += field("Nama Guru Tingkatan 2026", data.guru_tingkatan_2026);

  document.getElementById("resultBox").innerHTML = html;
  go("result");
}
</script>
